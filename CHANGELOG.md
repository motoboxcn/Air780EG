# Air780EG Arduino Library - 更新日志

## v1.2.2 (2025-07-23)

### 🔧 重大修复
- **修复串口并发冲突**：解决WiFi定位命令阻塞期间MQTT发布失败的问题
- **修复URC机制冲突**：解决GNSS响应被错误识别为MQTT消息的问题
- **修复MPUB发布失败**：恢复MQTT消息发布的正确同步行为
- **修复WiFi定位混乱**：添加阻塞命令管理，避免串口响应混合

### ✨ 新增功能
- **AT命令队列系统**：实现非阻塞AT命令队列管理
- **URC智能识别**：区分真正的URC和AT命令响应
- **阻塞命令管理**：WiFi/LBS定位期间暂停其他AT命令
- **命令类型识别**：自动识别不同类型的AT命令

### 🚀 性能优化
- **消除串口冲突**：通过队列机制避免并发AT命令冲突
- **智能响应解析**：基于命令类型的响应完整性判断
- **减少错误日志**：消除GNSS响应触发的JSON解析错误

### 🔄 架构改进
- **职责分离**：队列机制负责串口管理，URC机制负责主动上报
- **向下兼容**：保持现有API接口不变
- **统一串口管理**：避免多处直接读取串口造成冲突

### 📋 修复的问题
1. **MQTT发布失败**：虽然AT命令成功但publish()方法返回失败
2. **GNSS响应错误回调**：+CGNSINF响应被当作MQTT消息处理
3. **WiFi定位重复调用**：异步逻辑错误导致命令重复添加到队列
4. **串口响应混乱**：WiFi定位期间其他命令响应混合

### 🛠️ 技术细节
- 实现ATCommand结构体管理命令状态
- 添加命令类型识别和响应解析机制
- 实现阻塞命令状态管理
- 优化URC分发逻辑

### ⚠️ 注意事项
- 必须在主循环中调用`air780eg.loop()`
- WiFi/LBS定位期间会暂停GNSS更新
- 保持API向下兼容，现有代码无需修改

---

## v1.2.1 (之前版本)
- **重大修改**：移除自动WiFi/LBS定位切换功能，避免串口并发冲突
- **修复**：解决MQTT定时任务延迟问题，确保按时执行
- **优化**：将定位策略控制权交给用户，提高系统稳定性
- **新增**：定位状态查询方法 `isGNSSSignalLost()`, `getLocationSource()`, `getLastLocationTime()`

## v1.2.0 (之前版本)
- **重大更新**：完善定位功能，支持GNSS+LBS+WiFi三重定位
- **新增**：完整的MQTT客户端功能，支持SSL/TLS加密
- **新增**：URC管理器，支持主动上报消息处理
- **优化**：智能定位策略，自动选择最优定位方式

## v1.1.0 (之前版本)
- 新增MQTT基础功能
- 改进GNSS定位精度
- 优化缓存机制
- 增加更多调试选项

## v1.0.0 (之前版本)
- 初始版本发布
- 支持基本AT指令交互
- 支持网络管理功能
- 支持GNSS定位功能
- 完整的调试系统
